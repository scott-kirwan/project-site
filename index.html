<!doctype html>
<html lang="en">
  <head>
    <!-- Google Tag Manager -->
    <script>
      (function () {
        const carousel = document.querySelector('[data-carousel]');
        if (!carousel) return;

        const track = carousel.querySelector('[data-track]');
        const slides = Array.from(carousel.querySelectorAll('[data-slide]'));
        const prevBtn = carousel.querySelector('[data-prev]');
        const nextBtn = carousel.querySelector('[data-next]');
        const tabs = Array.from(carousel.querySelectorAll('[data-tab]'));
        const mq = window.matchMedia('(max-width: 960px)');

        let index = 0;

        function mod(n, m) {
          return ((n % m) + m) % m;
        }

        function setActiveTab(i) {
          tabs.forEach((t, ti) => {
            const active = ti === i;
            t.classList.toggle('is-active', active);
            t.setAttribute('aria-selected', active ? 'true' : 'false');
          });
        }

        function renderMobile(i) {
          index = i;
          slides.forEach((slide, si) => {
            slide.classList.toggle('is-active', si === index);
            slide.setAttribute('aria-hidden', si === index ? 'false' : 'true');
          });
          setActiveTab(index);
          track.style.height = ''; // natural flow on mobile
        }

        function renderDesktop() {
          slides.forEach((slide, i) => {
            const raw = i - index;
            const wrapped = raw > slides.length / 2 ? raw - slides.length : raw;
            const offset = wrapped < -slides.length / 2 ? wrapped + slides.length : wrapped;

            slide.classList.remove('is-active', 'is-prev', 'is-next', 'is-hidden');

            if (offset === 0) slide.classList.add('is-active');
            else if (offset === -1) slide.classList.add('is-prev');
            else if (offset === 1) slide.classList.add('is-next');
            else slide.classList.add('is-hidden');

            slide.setAttribute('aria-hidden', offset === 0 ? 'false' : 'true');
          });

          // Keep arrows centered on the full card
          const active = slides[index];
          if (active) track.style.height = active.offsetHeight + 'px';
        }

        function render() {
          if (mq.matches) return renderMobile(index);
          return renderDesktop();
        }

        function go(delta) {
          if (mq.matches) {
            // mobile tab behaviour
            renderMobile(mod(index + delta, slides.length));
            return;
          }
          index = mod(index + delta, slides.length);
          renderDesktop();
        }

        // Arrow buttons (desktop)
        prevBtn.addEventListener('click', (e) => { e.preventDefault(); go(-1); });
        nextBtn.addEventListener('click', (e) => { e.preventDefault(); go(1); });

        // Click peeking cards (desktop)
        slides.forEach((slide) => {
          slide.addEventListener('click', () => {
            if (mq.matches) return;
            if (slide.classList.contains('is-prev')) go(-1);
            if (slide.classList.contains('is-next')) go(1);
          });
        });

        // Keyboard (desktop)
        track.addEventListener('keydown', (e) => {
          if (mq.matches) return;
          if (e.key === 'ArrowLeft') { e.preventDefault(); go(-1); }
          if (e.key === 'ArrowRight') { e.preventDefault(); go(1); }
        });

        // Tabs (mobile)
        tabs.forEach((tab) => {
          tab.addEventListener('click', () => {
            const i = Number(tab.getAttribute('data-tab'));
            renderMobile(i);
          });
        });

        mq.addEventListener('change', () => {
          // reset visuals when switching modes
          index = 0;
          render();
        });

        window.addEventListener('resize', () => {
          window.requestAnimationFrame(render);
        });

        // Initial
        render();
      })();
    </script>

  </body>
</html>
